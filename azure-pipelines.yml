trigger:
- main  # Or dev/stage as needed

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: "1.9.5"
  workingDirectory: "$(System.DefaultWorkingDirectory)/Terraform/app-backend-infrastructure"

  backend_rg: "terraform-deploy"
  backend_sa: "terraformsflg"
  backend_container: "app-backend-infrastructure"
  backend_key: "terraform.tfstate"

  # Environment to deploy
  environment: "dev"

steps:

# Install Terraform manually
- bash: |
    echo "Installing Terraform version $(terraformVersion)..."
    wget https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
    unzip terraform_$(terraformVersion)_linux_amd64.zip
    sudo mv terraform /usr/local/bin/
    terraform -version
  displayName: "Install Terraform"

# Azure Login
- task: AzureCLI@2
  displayName: "Azure Login"
  inputs:
    azureSubscription: 'Azure subscription 1(1)(525c7c1f-f5e9-4bf4-8d7a-5b7a06889a12)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "Logged into Azure"
      az account show

# Terraform Init
- bash: |
    cd "$(workingDirectory)"
    terraform init \
      -input=false \
      -backend-config="resource_group_name=$(backend_rg)" \
      -backend-config="storage_account_name=$(backend_sa)" \
      -backend-config="container_name=$(backend_container)" \
      -backend-config="key=$(backend_key)"
  displayName: "Terraform Init"

# Terraform Validate
- bash: |
    cd "$(workingDirectory)"
    terraform validate
  displayName: "Terraform Validate"

# Terraform Plan
- bash: |
    cd "$(workingDirectory)"
    echo "Deploying environment: $(environment)"
    terraform plan \
      -input=false \
      -var-file="Standard-build-Infrastructure/app-backend-infrastructure/environments/$(environment)/terraform.tfvars" \
      -out=plan.tfplan
  displayName: "Terraform Plan"

# Publish Plan
- task: PublishBuildArtifacts@1
  displayName: "Publish Terraform Plan"
  inputs:
    PathtoPublish: "$(workingDirectory)/plan.tfplan"
    ArtifactName: "tfplan"

# Terraform Apply
- bash: |
    cd "$(workingDirectory)"
    terraform apply -input=false -auto-approve plan.tfplan
  displayName: "Terraform Apply"